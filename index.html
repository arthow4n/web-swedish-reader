<html>
  <head>
    <title>web-swedish-reader</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="canonical"
      href="https://arthow4n.github.io/web-swedish-reader/"
    />

    <link
      rel="modulepreload"
      href="https://cdn.jsdelivr.net/npm/idb-keyval@6/+esm"
    />
    <link rel="modulepreload" href="./js/dictionaryDatabase.mjs" />
    <link rel="modulepreload" href="./js/dictionaryView.mjs" />
    <link rel="modulepreload" href="./js/utils.mjs" />
    <link
      rel="modulepreload"
      href="/web-swedish-reader-data/folkets-compound/folkets-compound.meta.mjs"
    />
    <link
      rel="modulepreload"
      href="/web-swedish-reader-data/folkets-sven/folkets-sven.meta.mjs"
    />

    <link
      rel="stylesheet"
      type="text/css"
      href="https://unpkg.com/normalize.css@8.0.1/normalize.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://unpkg.com/sakura.css@1.3.1/css/sakura.css"
    />
    <link rel="stylesheet" type="text/css" href="./css/index.css" />
  </head>
  <body>
    <div class="reader">
      <main>
        <div class="leading-controls">
          <span>
            <button class="control-clear edit-mode-hidden">Clear</button>
            <button class="control-edit edit-mode-hidden">Edit</button>
            <button class="control-finish-edit edit-mode-only">
              Finish edit
            </button>
            <button class="control-import edit-mode-only">Import</button></span
          >
          <span>
            <a href="bookmarklets.html" target="_blank">Bookmarklets</a> |
            <a
              href="https://github.com/arthow4n/web-swedish-reader"
              target="_blank"
              rel="noopener noreferrer"
              >GitHub</a
            >
          </span>
        </div>
        <article></article>
        <div class="ending-controls edit-mode-hidden">
          <button class="control-clear">Clear</button>
          <button class="control-import">Import</button>
        </div>
      </main>
      <aside class="dics">
        <div class="aside-row edit-mode-only query-expanded-hidden">
          <button class="control-finish-edit">Finish edit</button>
          <button class="control-import">Import</button>
        </div>
        <div class="aside-row">
          <div class="query-alternatives">
            <p
              class="query-alternatives-line query-alternatives-line-local"
            ></p>
            <p
              class="query-alternatives-line query-alternatives-line-remote"
            ></p>
            <p
              class="query-alternatives-line query-alternatives-line-swedish-definition"
            ></p>
            <p
              class="query-alternatives-line query-alternatives-line-english-translation"
            ></p>
          </div>
          <div class="query-alternatives-floating-button-row">
            <!-- TODO: OCR <button type="button" class="control-deeper-alternatives">ðŸ“¸</button  > -->
            <button type="button" class="control-full-screen">ðŸ”³</button>
          </div>
        </div>
        <form class="form-dics-query">
          <div class="flex">
            <input class="dics-query-input" /><button
              type="button"
              class="control-search-google"
            >
              Goo</button
            ><button type="button" class="control-search-tyda">Tyd</button
            ><button type="button" class="control-search-wiktionary">Wik</button
            ><button type="button" class="control-deeper-alternatives">
              â†‘â†‘
            </button>
          </div>
          <label class="control-label label-dics-expand"
            ><span class="control-label-text">+ </span
            ><span><input type="checkbox" /></span
          ></label>
        </form>
        <div class="dic dic-sub-single">
          <iframe
            class="dic-iframe dic-cambridge"
            referrerpolicy="no-referrer"
          ></iframe>
          <p>Cambridge Dictionary</p>
        </div>
        <!-- Temporarily commented out to get a feeling of whether if this is really needed -->
        <!-- <div class="dic">
          <iframe
            class="dic-iframe dic-folkets"
            referrerpolicy="no-referrer"
          ></iframe>
          <p>Folkets lexikon</p>
        </div> -->
        <div class="dic">
          <iframe
            class="dic-iframe dic-saol"
            referrerpolicy="no-referrer"
          ></iframe>
          <p>SAOL/SO/SAOB</p>
        </div>
      </aside>
    </div>
    <script type="module">
      import {
        setIsQueryExpanded,
        updateDictionaryViews,
      } from "./js/dictionaryView.mjs";
      import { toWordSpans, debounce } from "./js/utils.mjs";

      const clearAndEditButtons = document.querySelectorAll(".control-clear");
      const editButton = document.querySelector(".control-edit");
      const importButtons = document.querySelectorAll(".control-import");
      const finishEditButtons = document.querySelectorAll(
        ".control-finish-edit"
      );
      const fullScreenButton = document.querySelector(".control-full-screen");
      const main = document.querySelector("main");
      const article = document.querySelector("article");
      const dicSubSingle = document.querySelector(".dic-sub-single");
      const cambridge = document.querySelector(".dic-cambridge");

      const setMainScrollState = (num) => {
        const url = new URL(location);
        if (num) {
          url.searchParams.set("mainScroll", num.toFixed(0));
        } else {
          url.searchParams.delete("mainScroll");
        }
        history.replaceState(undefined, undefined, url);
      };

      const onMainScroll = debounce(() => {
        setMainScrollState(main.scrollTop);
      });

      const updateArticle = (input, init = false) => {
        history.pushState(
          undefined,
          undefined,
          "#text=" + encodeURIComponent(input)
        );

        const text = input.trim();
        if (!text) {
          article.innerHTML = "";
          return;
        }

        article.innerHTML = text
          .split("\n")
          .map((line) => {
            return (
              "<p>" +
              line
                .split(/\s+/)
                .filter((x) => x.trim())
                .map((x) => toWordSpans(x))
                .join(" ") +
              "</p>"
            );
          })
          .join("");

        main.scrollTo(
          0,
          init
            ? parseInt(new URL(location).searchParams.get("mainScroll"), 10) ||
                0
            : 0
        );
        main.addEventListener("scroll", onMainScroll);
      };

      const setIsEditMode = (isEditable, init = false) => {
        document.body.classList.remove("is-edit-mode");

        if (isEditable) {
          main.removeEventListener("scroll", onMainScroll);
          setMainScrollState(0);
          document.body.classList.add("is-edit-mode");
          article.contentEditable = "plaintext-only";
          article.focus();

          if (!init) {
            setIsQueryExpanded(false);
          }

          return;
        }

        if (!init) {
          updateArticle(article.innerText);
        }

        article.contentEditable = false;
      };

      {
        const dictionaryQuery = new URL(location).searchParams.get(
          "dictionaryQuery"
        );
        if (dictionaryQuery) {
          updateDictionaryViews(dictionaryQuery);
        }

        const hashQuery = new URLSearchParams(location.hash.slice(1));
        const hashText = hashQuery.get("text");
        setIsQueryExpanded(!!(dictionaryQuery && !hashText));

        if (hashText) {
          updateArticle(hashText, true);
        }

        setIsEditMode(!article.innerText.trim(), true);
      }

      let hasShownCambridgeDictionary = false;
      document.addEventListener("click", (event) => {
        if (
          (article.isContentEditable && event.target.closest("article")) ||
          !event.target.closest("article,.query-alternatives")
        ) {
          return;
        }

        const isInsideAlternatives = !!event.target.closest(
          ".query-alternatives"
        );

        if (event.target.classList.contains("word-english")) {
          dicSubSingle.classList.add("active");
          const show = () => {
            const next = `https://dictionary.cambridge.org/dictionary/english/${event.target.innerText}`;
            if (cambridge.src !== next) {
              // There's a very aggressive cookie modal inside that doesn't stop showing even after accepting.
              cambridge.sandbox = "";
              cambridge.src = next;
            }
          };

          if (hasShownCambridgeDictionary) {
            show();
          } else {
            hasShownCambridgeDictionary = true;
            setTimeout(show, 1500);
          }

          return;
        }

        if (!event.target.classList.contains("word")) return;
        updateDictionaryViews(event.target.innerText, {
          keepQueryAlternatives: isInsideAlternatives,
        });
      });

      clearAndEditButtons.forEach((x) =>
        x.addEventListener("click", () => {
          article.innerHTML = "";
          setIsEditMode(true);
        })
      );
      editButton.addEventListener("click", () => {
        setIsEditMode(true);
      });
      finishEditButtons.forEach((x) => {
        x.addEventListener("click", () => {
          setIsEditMode(false);
        });
      });

      importButtons.forEach((x) =>
        x.addEventListener("click", () => {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = ".txt";
          input.multiple = true;
          input.hidden = true;
          input.onchange = async (event) => {
            const allFiles = await Promise.all(
              [...event.target.files].map(
                (file) =>
                  new Promise((resolve) => {
                    const r = new FileReader();
                    r.onload = () => {
                      resolve(
                        `==start: ${file.name}\n\n${r.result}\n\n==end: ${file.name}`
                      );
                    };
                    r.onerror = (r) => {
                      resolve("");
                    };

                    r.readAsText(file);
                  })
              )
            );
            document.body.removeChild(input);
            article.innerText = allFiles.join("\n\n");
            setIsEditMode(false);
          };

          document.body.appendChild(input);
          input.click();
        })
      );

      fullScreenButton.addEventListener("click", () => {
        if (document.fullscreenElement) {
          document.exitFullscreen();
          return;
        }

        document.documentElement.requestFullscreen();
      });
    </script>
  </body>
</html>
